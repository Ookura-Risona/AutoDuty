name: Auto Sync Upstream with AI

on:
  schedule:
    - cron: '0 0,12 * * *'
  workflow_dispatch:

env:
  UPSTREAM_REPO: 'ffxivcode/AutoDuty'
  UPSTREAM_BRANCH: 'master'
  TARGET_BRANCH: 'master'
  AI_MODEL: 'deepseek-chat'

jobs:
  check-and-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Configure Git with PAT
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config url."https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/".insteadOf "https://github.com/"
      
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git || true
          git fetch upstream
      
      - name: Check for new commits
        id: check_commits
        run: |
          UPSTREAM_COMMIT=$(git rev-parse upstream/${{ env.UPSTREAM_BRANCH }})
          CURRENT_COMMIT=$(git rev-parse HEAD)
          
          echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
          echo "current_commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
          
          if [ "$UPSTREAM_COMMIT" = "$CURRENT_COMMIT" ]; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "âœ… Already up to date with upstream"
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
            
            git log --pretty=format:"%H|%s|%b" HEAD..upstream/${{ env.UPSTREAM_BRANCH }} > new_commits.txt
            git diff HEAD..upstream/${{ env.UPSTREAM_BRANCH }} --name-status > changed_files.txt
            
            echo "ğŸ“ New commits found"
            cat new_commits.txt
            echo ""
            echo "ğŸ“ Changed files:"
            cat changed_files.txt
          fi
      
      - name: Get changed file contents
        if: steps.check_commits.outputs.has_updates == 'true'
        run: |
          git diff HEAD..upstream/${{ env.UPSTREAM_BRANCH }} > full_diff.txt
          
          if [ $(wc -c < full_diff.txt) -gt 50000 ]; then
            echo "âš ï¸ Diff too large, creating summary"
            git diff HEAD..upstream/${{ env.UPSTREAM_BRANCH }} --stat > diff_summary.txt
          else
            cp full_diff.txt diff_summary.txt
          fi
      
      - name: Setup Python
        if: steps.check_commits.outputs.has_updates == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        if: steps.check_commits.outputs.has_updates == 'true'
        run: pip install openai
      
      - name: Analyze changes with DeepSeek AI
        if: steps.check_commits.outputs.has_updates == 'true'
        id: ai_analysis
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          python << 'PYTHON_SCRIPT'
          import os
          import sys
          import json
          from openai import OpenAI

          client = OpenAI(
              api_key=os.environ['DEEPSEEK_API_KEY'],
              base_url="https://api.deepseek.com"
          )

          with open('new_commits.txt', 'r', encoding='utf-8') as f:
              commits = f.read()
          with open('diff_summary.txt', 'r', encoding='utf-8') as f:
              diff = f.read()
          with open('changed_files.txt', 'r', encoding='utf-8') as f:
              files = f.read()

          prompt = f"""ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç åˆ†æåŠ©æ‰‹ã€‚è¿™æ˜¯ä¸€ä¸ªFinal Fantasy XIV (FF14) Dalamudæ’ä»¶AutoDutyçš„æ±‰åŒ–ä»“åº“ã€‚

          ä¸Šæ¸¸ä»“åº“æœ‰æ–°çš„æäº¤ï¼Œè¯·åˆ†æä»¥ä¸‹å†…å®¹ï¼š

          ## æ–°æäº¤ä¿¡æ¯ï¼š
          {commits}

          ## å˜æ›´æ–‡ä»¶åˆ—è¡¨ï¼š
          {files}

          ## ä»£ç å˜æ›´è¯¦æƒ…ï¼š
          {diff[:15000]}

          è¯·åˆ†æå¹¶å›ç­”ï¼š
          1. è¿™äº›æäº¤æ˜¯å¦åŒ…å«éœ€è¦ç¿»è¯‘çš„ç”¨æˆ·ç•Œé¢æ–‡æœ¬ã€æ¶ˆæ¯æˆ–æ–‡æ¡£ï¼Ÿ
          2. å¦‚æœéœ€è¦ç¿»è¯‘ï¼Œè¯·åˆ—å‡ºæ‰€æœ‰éœ€è¦ç¿»è¯‘çš„æ–‡æœ¬å†…å®¹ï¼Œå¹¶æä¾›å‡†ç¡®çš„ä¸­æ–‡ç¿»è¯‘ã€‚
          3. æ˜¯å¦å­˜åœ¨å¯èƒ½çš„åˆå¹¶å†²çªï¼Ÿç‰¹åˆ«æ˜¯ä¸æ±‰åŒ–ç›¸å…³çš„æ–‡ä»¶å†²çªã€‚
          4. æä¾›åˆå¹¶å»ºè®®ã€‚

          ç¿»è¯‘æ³¨æ„äº‹é¡¹ï¼š
          - ä¿æŒFF14å®˜æ–¹æ¸¸æˆæœ¯è¯­ï¼ˆå¦‚èŒèƒ½ã€å‰¯æœ¬ã€æŠ€èƒ½åç§°ç­‰ï¼‰
          - UIæ–‡æœ¬ç®€æ´æ˜äº†ï¼Œç¬¦åˆä¸­æ–‡ä¹ æƒ¯
          - ä¿ç•™ä»£ç ä¸­çš„æŠ€æœ¯æœ¯è¯­ï¼ˆå¦‚ç±»åã€å‡½æ•°åã€å˜é‡åã€APIåç§°ç­‰ï¼‰
          - ä¿æŒæ ¼å¼åŒ–å­—ç¬¦ä¸²çš„å ä½ç¬¦ä¸å˜ï¼ˆå¦‚ {{0}}, %s, {{name}} ç­‰ï¼‰
          - æ³¨é‡Šä¹Ÿéœ€è¦ç¿»è¯‘

          è¯·ä»¥JSONæ ¼å¼å›å¤ï¼ˆå¿…é¡»æ˜¯æœ‰æ•ˆçš„JSONï¼‰ï¼š
          {{
            "needs_translation": trueæˆ–false,
            "translation_required": "ç®€è¦è¯´æ˜ä¸ºä»€ä¹ˆéœ€è¦æˆ–ä¸éœ€è¦ç¿»è¯‘",
            "translations": [
              {{"file": "æ–‡ä»¶è·¯å¾„", "original": "åŸæ–‡", "translated": "è¯‘æ–‡", "line": è¡Œå·æˆ–null, "context": "ä¸Šä¸‹æ–‡è¯´æ˜"}}
            ],
            "potential_conflicts": ["å¯èƒ½å†²çªçš„æ–‡ä»¶åˆ—è¡¨"],
            "merge_strategy": "å»ºè®®çš„åˆå¹¶ç­–ç•¥ï¼ˆauto/manual/reviewï¼‰",
            "summary": "æ€»ä½“åˆ†ææ‘˜è¦ï¼ŒåŒ…æ‹¬ä¸»è¦å˜æ›´å†…å®¹"
          }}
          """

          try:
              response = client.chat.completions.create(
                  model=os.environ.get('AI_MODEL', 'deepseek-chat'),
                  messages=[
                      {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æœ¬åœ°åŒ–å’Œä»£ç åˆ†æä¸“å®¶ï¼Œç²¾é€šè‹±æ–‡å’Œä¸­æ–‡ï¼Œç‰¹åˆ«äº†è§£Final Fantasy XIVæ¸¸æˆå’Œè½¯ä»¶å¼€å‘ã€‚è¯·å§‹ç»ˆè¿”å›æœ‰æ•ˆçš„JSONæ ¼å¼ã€‚"},
                      {"role": "user", "content": prompt}
                  ],
                  temperature=0.3,
                  max_tokens=4000
              )
              
              content = response.choices[0].message.content
              
              if "```json" in content:
                  content = content.split("```json")[1].split("```")[0].strip()
              elif "```" in content:
                  content = content.split("```")[1].split("```")[0].strip()
              
              data = json.loads(content)
              
              print("âœ… DeepSeek AI Analysis Result:")
              print(json.dumps(data, ensure_ascii=False, indent=2))
              
              with open('ai_analysis.json', 'w', encoding='utf-8') as f:
                  json.dump(data, f, ensure_ascii=False, indent=2)
              
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"needs_translation={str(data.get('needs_translation', False)).lower()}\n")
                  
          except Exception as e:
              print(f"âŒ Error: {e}")
              sys.exit(1)
          PYTHON_SCRIPT
      
      - name: Create translation branch
        if: steps.check_commits.outputs.has_updates == 'true' && steps.ai_analysis.outputs.needs_translation == 'true'
        id: create_branch
        run: |
          BRANCH_NAME="sync-upstream-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
      
      - name: Merge and resolve conflicts with AI
        if: steps.check_commits.outputs.has_updates == 'true' && steps.ai_analysis.outputs.needs_translation == 'true'
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          python << 'PYTHON_SCRIPT'
          import os
          import json
          import subprocess
          from openai import OpenAI

          client = OpenAI(
              api_key=os.environ['DEEPSEEK_API_KEY'],
              base_url="https://api.deepseek.com"
          )

          print("ğŸ”„ Attempting to merge upstream changes...")
          result = subprocess.run(
              ['git', 'merge', f"upstream/{os.environ['UPSTREAM_BRANCH']}"],
              capture_output=True,
              text=True
          )
          
          if result.returncode != 0:
              print("âš ï¸ Merge conflicts detected, asking DeepSeek AI for resolution...")
              
              conflicts_result = subprocess.run(
                  ['git', 'diff', '--name-only', '--diff-filter=U'],
                  capture_output=True,
                  text=True
              )
              conflicts = [f for f in conflicts_result.stdout.strip().split('\n') if f]
              
              if not conflicts:
                  print("âŒ Merge failed but no conflicts found")
                  subprocess.run(['git', 'merge', '--abort'])
                  exit(1)
              
              print(f"Found {len(conflicts)} conflicted file(s)")
              
              for conflict_file in conflicts:
                  print(f"ğŸ”§ Resolving conflict in: {conflict_file}")
                  
                  try:
                      with open(conflict_file, 'r', encoding='utf-8') as f:
                          conflict_content = f.read()
                  except Exception as e:
                      print(f"âŒ Failed to read {conflict_file}: {e}")
                      continue
                  
                  prompt = f"""è¿™æ˜¯ä¸€ä¸ªæ±‰åŒ–ä»“åº“çš„Gitåˆå¹¶å†²çªã€‚è¯·æ™ºèƒ½è§£å†³è¿™ä¸ªå†²çªã€‚

          æ–‡ä»¶: {conflict_file}

          å†²çªå†…å®¹:
          {conflict_content}

          è§£å†³åŸåˆ™:
          1. ä¿ç•™ä¸­æ–‡ç¿»è¯‘ï¼ˆé€šå¸¸åœ¨ <<<<<<< HEAD éƒ¨åˆ†ï¼‰
          2. æ•´åˆä¸Šæ¸¸çš„ä»£ç ç»“æ„å˜æ›´ï¼ˆåœ¨ >>>>>>> upstream éƒ¨åˆ†ï¼‰
          3. å¦‚æœä¸Šæ¸¸ä¿®æ”¹äº†è‹±æ–‡åŸæ–‡ï¼Œè¯·åŸºäºæ–°çš„è‹±æ–‡æ›´æ–°ä¸­æ–‡ç¿»è¯‘
          4. ä¿æŒä»£ç çš„åŠŸèƒ½å®Œæ•´æ€§å’Œè¯­æ³•æ­£ç¡®æ€§
          5. åˆ é™¤æ‰€æœ‰å†²çªæ ‡è®°ï¼ˆ<<<<<<<, =======, >>>>>>>ï¼‰
          6. ä¿æŒåŸæœ‰çš„ä»£ç æ ¼å¼å’Œç¼©è¿›

          è¯·ç›´æ¥æä¾›è§£å†³åçš„å®Œæ•´æ–‡ä»¶å†…å®¹ï¼Œä¸è¦æœ‰ä»»ä½•è§£é‡Šæˆ–markdownæ ‡è®°ã€‚"""
                  
                  try:
                      response = client.chat.completions.create(
                          model=os.environ.get('AI_MODEL', 'deepseek-chat'),
                          messages=[
                              {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„Gitå†²çªè§£å†³ä¸“å®¶å’Œæœ¬åœ°åŒ–ä¸“å®¶ã€‚ä½ çš„è¾“å‡ºå°†ç›´æ¥å†™å…¥æ–‡ä»¶ï¼Œæ‰€ä»¥ä¸è¦åŒ…å«ä»»ä½•é¢å¤–çš„è¯´æ˜æˆ–æ ‡è®°ã€‚"},
                              {"role": "user", "content": prompt}
                          ],
                          temperature=0.1,
                          max_tokens=8000
                      )
                      
                      resolved_content = response.choices[0].message.content.strip()
                      
                      if resolved_content.startswith("```"):
                          lines = resolved_content.split('\n')
                          if lines[0].startswith("```"):
                              lines = lines[1:]
                          if lines[-1].startswith("```"):
                              lines = lines[:-1]
                          resolved_content = '\n'.join(lines)
                      
                      with open(conflict_file, 'w', encoding='utf-8') as f:
                          f.write(resolved_content)
                      
                      subprocess.run(['git', 'add', conflict_file], check=True)
                      print(f"âœ… Resolved: {conflict_file}")
                      
                  except Exception as e:
                      print(f"âŒ Failed to resolve {conflict_file}: {e}")
                      subprocess.run(['git', 'merge', '--abort'])
                      exit(1)
              
              subprocess.run(['git', 'commit', '--no-edit'], check=True)
              print("âœ… All conflicts resolved with AI assistance")
          else:
              print("âœ… Merge successful without conflicts")
          PYTHON_SCRIPT
      
      - name: Check if branch has new commits
        if: steps.check_commits.outputs.has_updates == 'true' && steps.ai_analysis.outputs.needs_translation == 'true'
        id: check_branch_diff
        run: |
          # æ£€æŸ¥å½“å‰åˆ†æ”¯ä¸ç›®æ ‡åˆ†æ”¯çš„å·®å¼‚
          DIFF_COUNT=$(git rev-list --count origin/${{ env.TARGET_BRANCH }}..${{ steps.create_branch.outputs.branch_name }})
          echo "diff_count=$DIFF_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$DIFF_COUNT" -eq "0" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No new commits in branch, will skip PR creation"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Branch has $DIFF_COUNT new commit(s)"
          fi
      
      - name: Push branch
        if: steps.check_commits.outputs.has_updates == 'true' && steps.ai_analysis.outputs.needs_translation == 'true' && steps.check_branch_diff.outputs.has_changes == 'true'
        run: |
          git push origin ${{ steps.create_branch.outputs.branch_name }}
      
      - name: Direct merge if no translation needed
        if: steps.check_commits.outputs.has_updates == 'true' && steps.ai_analysis.outputs.needs_translation == 'false'
        run: |
          echo "âœ… No translation needed, merging directly..."
          git merge upstream/${{ env.UPSTREAM_BRANCH }} -m "chore: sync with upstream (no translation needed)"
          git push origin ${{ env.TARGET_BRANCH }}
      
      - name: Create Pull Request
        if: steps.check_commits.outputs.has_updates == 'true' && steps.ai_analysis.outputs.needs_translation == 'true' && steps.check_branch_diff.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          ANALYSIS=$(cat ai_analysis.json | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('summary', 'AIåˆ†æå®Œæˆ'))")
          TRANSLATION_COUNT=$(cat ai_analysis.json | python3 -c "import sys, json; data=json.load(sys.stdin); print(len(data.get('translations', [])))")
          
          cat << EOF > pr_body.md
          ## ğŸ¤– è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸æ›´æ–°
          
          æ­¤PRç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºï¼ŒåŒ…å«æ¥è‡ªä¸Šæ¸¸ä»“åº“çš„æ–°æäº¤ã€‚
          
          ### ğŸ“Š AIåˆ†æç»“æœ
          
          $ANALYSIS
          
          ### ğŸ“ ç¿»è¯‘ç»Ÿè®¡
          
          - æ£€æµ‹åˆ°éœ€è¦ç¿»è¯‘çš„é¡¹ç›®: **${TRANSLATION_COUNT}** ä¸ª
          - AIæ¨¡å‹: \`${{ env.AI_MODEL }}\`
          
          ### âœ… å·²è‡ªåŠ¨å¤„ç†
          
          - âœ“ AI å·²åˆ†æå˜æ›´å†…å®¹
          - âœ“ AI å·²æä¾›ä¸­æ–‡ç¿»è¯‘å»ºè®®
          - âœ“ åˆå¹¶å†²çªå·²ç”± AI è¾…åŠ©è§£å†³ï¼ˆå¦‚æœ‰ï¼‰
          
          ### ğŸ‘€ éœ€è¦äººå·¥å®¡æŸ¥
          
          è¯·ä»”ç»†æ£€æŸ¥ï¼š
          1. **ç¿»è¯‘è´¨é‡å’Œå‡†ç¡®æ€§** - ç¡®ä¿ç¬¦åˆFF14å®˜æ–¹æœ¯è¯­
          2. **ä»£ç åˆå¹¶çš„æ­£ç¡®æ€§** - éªŒè¯åŠŸèƒ½å®Œæ•´æ€§
          3. **æ¸¸æˆæœ¯è¯­çš„ä¸€è‡´æ€§** - ä¸ç°æœ‰ç¿»è¯‘ä¿æŒç»Ÿä¸€
          4. **æ ¼å¼å’Œæ’ç‰ˆ** - ç¡®ä¿UIæ˜¾ç¤ºæ­£å¸¸
          
          <details>
          <summary>ğŸ“‹ å®Œæ•´AIåˆ†ææŠ¥å‘Šï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>
          
          \`\`\`json
          $(cat ai_analysis.json)
          \`\`\`
          
          </details>
          
          ---
          
          **ä¸Šæ¸¸æäº¤**: \`${{ steps.check_commits.outputs.upstream_commit }}\`  
          **ç”Ÿæˆæ—¶é—´**: $(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M:%S UTC+8")
          EOF
          
          gh pr create \
            --title "ğŸŒ åŒæ­¥ä¸Šæ¸¸æ›´æ–° - $(TZ='Asia/Shanghai' date +%Y-%m-%d)" \
            --body-file pr_body.md \
            --base ${{ env.TARGET_BRANCH }} \
            --head ${{ steps.create_branch.outputs.branch_name }} \
            --label "upstream-sync,translation,automated"
      
      - name: Skip PR creation (no changes)
        if: steps.check_commits.outputs.has_updates == 'true' && steps.ai_analysis.outputs.needs_translation == 'true' && steps.check_branch_diff.outputs.has_changes == 'false'
        run: |
          echo "âš ï¸ Branch has no new commits compared to target branch"
          echo "This might happen if the merge resulted in no actual changes"
          echo "Cleaning up branch..."
          git checkout ${{ env.TARGET_BRANCH }}
          git branch -D ${{ steps.create_branch.outputs.branch_name }} || true
      
      - name: Create summary
        if: always()
        run: |
          echo "## ğŸ”„ ä¸Šæ¸¸åŒæ­¥æ£€æŸ¥ (DeepSeek AI)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_commits.outputs.has_updates }}" = "true" ]; then
            echo "âœ… å‘ç°æ–°çš„ä¸Šæ¸¸æäº¤" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- éœ€è¦ç¿»è¯‘: **${{ steps.ai_analysis.outputs.needs_translation }}**" >> $GITHUB_STEP_SUMMARY
            echo "- AIæ¨¡å‹: \`${{ env.AI_MODEL }}\`" >> $GITHUB_STEP_SUMMARY
            
            if [ -f "ai_analysis.json" ]; then
              TRANSLATION_COUNT=$(cat ai_analysis.json | python3 -c "import sys, json; data=json.load(sys.stdin); print(len(data.get('translations', [])))" 2>/dev/null || echo "0")
              echo "- æ£€æµ‹åˆ°ç¿»è¯‘é¡¹: **${TRANSLATION_COUNT}** ä¸ª" >> $GITHUB_STEP_SUMMARY
              
              if [ "${{ steps.check_branch_diff.outputs.has_changes }}" = "false" ]; then
                echo "- âš ï¸ åˆå¹¶åæ— å®é™…å˜æ›´ï¼Œå·²è·³è¿‡PRåˆ›å»º" >> $GITHUB_STEP_SUMMARY
              fi
              
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ğŸ“Š DeepSeek AIåˆ†æç»“æœ" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
              cat ai_analysis.json >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ… å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€åŒæ­¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Powered by [DeepSeek AI](https://www.deepseek.com/)*" >> $GITHUB_STEP_SUMMARY
